---
layout: post
title: "Описание устройства"
comments: false
date: 2015-09-04
---
  
#Аппаратная часть.  
&nbsp;&nbsp;&nbsp;&nbsp;
Схема электрическая принципиальная:  
[![Схема устройства]({{site.baseurl}}/images/scheme.png)](https://github.com/y-salnikov/uknc_sd_fdd/blob/master/Hardware/uknc_sd_fdd_sch._pdf?raw=true)

&nbsp;&nbsp;&nbsp;&nbsp;
Устройство разработано на основе микросхемы серии
PSoC4 от cypress - CY8C4245AXI-483, которая кроме обычного микроконтроллера
на основе ARM Cortex-M0, содержит весьма необычные программируемые цифровые
блоки UDB, а также программно коммутируемые аналоговые блоки. Цифровые блоки - это
не программная эмуляция логических элементов на микроконтроллере, а полноценные цифровые
блоки программно коммутируемые с внешними выводами, между собой и с микроконтроллером, как
маленькая ПЛИС.  
&nbsp;&nbsp;&nbsp;&nbsp;
Шина МПИ, используемая
в УКНЦ, имеет совмещенные линии адреса и данных, что требует наличие регистра
хранения адреса в устройстве. Использование блоков UDB для защелкивания и
проверки диапазона адреса, обеспечивает достаточную скорость для взаимодействия
устройства с УКНЦ по шине.  
![Конфигурация ]({{site.baseurl}}/images/psoc_udb_config.png)  
<font size=-2><i>Схема конфигурации цифровых блоков в программе PSoC Creator</i></font>

&nbsp;&nbsp;&nbsp;&nbsp;
Поступающий с шины адрес инвертируется и сохраняется в регистре адреса,
представленном на схеме в виде пары 8-разрядных D-трипперов. Защелкивание происходит
по сигналу СИА. Далее с помощью логических элементов происходит определение принадлежность
захваченного адреса устройству, проверка выбора нужного банка нужной кассеты ПЗУ, определение
вида операции и поддиапозона, которому принадлежит адрес. Результат этих проверок
читается микроконтроллером через регистр STATE:

* 0-й разряд - чтение по адресу 0100000-0115776 
* 1-й разряд - чтение по адресу 0116000-0117776
* 2-й разряд - запись по адресу 0116000-0117776

&nbsp;&nbsp;&nbsp;&nbsp;
Разряды регистра STATE устанавливаются только если выбран первый банк кассеты ПЗУ.  
&nbsp;&nbsp;&nbsp;&nbsp;
При ненулевом значении этого регистра, микроконтроллер читает или устанавливает значение на шине и
формирует СИП согласно протоколу МПИ.  
&nbsp;&nbsp;&nbsp;&nbsp;
Также к PSoC4 подключена SD-карта, работающая по протоколу SPI. Функционирование SPI
осуществляется через блок последовательного интерфейса, который, в отличие от UDB,
жестко привязан к порту 4 микросхемы. SD-карта питается от 3.3 вольта, для понижения
напряжения используется стабилизатор с низким падением напряжения, например белорусский
K1235ЕН3БП или LM2931AZ. Выводы SD-карты защищены от перенапряжения (не очень хорошо, правда).

&nbsp;&nbsp;&nbsp;&nbsp;
Все сигналы могут быть переназначены на различные выводы PSoC4, кроме порта 4. В прототипе
используется следующая конфигурация.

![Конфигурация выводов]({{site.baseurl}}/images/psoc_pin_config.png)  
<font size=-2><i>Схема конфигурации выводов в PSoC Creator</i></font>

&nbsp;&nbsp;&nbsp;&nbsp;
Устройство тактируется от внутреннего RC-генератора на частоте 48МГц, стабильность не нужна.

#Управляющая программа в PSoC.

&nbsp;&nbsp;&nbsp;&nbsp;
Основной цикл программы непрерывно читает регистр STATE и в случае появления в одном
из разрядов единицы, осуществляет следующие действия:

* При чтении по адресам 0100000-0115776 произходит выдача слова из массива расположенного
во флэш-памяти PSoC4. Таким образом на эти адреса отображается "прошивка" устройства,
содержащая начальный загрузчик кассеты ПЗУ и драйвер. Линия БАЙТ работает только с этим диапазоном
но не используется программой в УКНЦ (сделано для отладочных целей).
* При чтении или записи по адресам 0116000-0117776 происходит чтение или запись в
буфер ОЗУ PSoC, т.е. на эти адреса отображается 1Кбайт памяти.
* При записи в адрес 0117776 происходит выполнение команды, код которой передан в
записываемом слове. Параметры команды передаются через буфер 0116000-0117774.  

&nbsp;&nbsp;&nbsp;&nbsp;
При выполнении данных действий, устройство формирует сигнал подтверждения СИП. Однако,
в программе не использовались прерывания и при выполнении команд микроконтроллер
перестает обслуживать шину МПИ, если в этот момент произойдет обращение УКНЦ по
адресам устройства - произойдет зависание по вектору 4. Чтобы этого избежать используется
линия ИНДЕКС. При выполнении команды, после формирования СИП, на данную линию выставляется
единица, а после завершения выполнения сбрасывается в ноль и процессор в PSoC возвращается
к обслуживанию шины МПИ. Таким образо, перефирийный процессор УКНЦ после запуска
команды (запись в 0117776) должен читать значение с линии ИНДЕКС и ожидать готовности.
Сигнал управления светодиодом LED повторяет значение ИНДЕКС.  
&nbsp;&nbsp;&nbsp;&nbsp;
Для работы с файловой системой на SD-карте используется библиотека 
[FatFS от elm-chan](http://elm-chan.org/fsw/ff/00index_e.html). Поддерживается как
обычные SD-карты, так и более новые SDHC. Карта должна содержать один раздел, отформатированный
в FAT. Образы дисков хранятся в каталоге disks, при этом файлы должны быть именованы
в формате 8.3, т.е. длина файла не должна превышать восьми символов, а расширение - трех.
Также не следует использовать кириллические имена файлов из-за несоответствия кодировок
в УКНЦ и DOS/Windows.  
&nbsp;&nbsp;&nbsp;&nbsp;
Устройство поддерживает 4 дисковода. Привязка виртуального дисковода к образу осуществляется
с помощью файла map.txt в корне SD-карты. Содержимое файла имеет следующий формат:  
{% highlight text  %}
N:<filename>
Например:
1:image1.dsk
2:ImAgE2.DsK
3:games.dsk
4:empty.dsk
{% endhighlight %}  
&nbsp;&nbsp;&nbsp;&nbsp;
Номер диска начинается с 1. Если какого-либо файла-образа нет, то он будет создан,
размер создаваемого образа определяется типом диска. Поддерживаются следующие типы дисков:  

* 1 - Односторонний дисковод, размер образа 400Кб. Поддерживается родным ПО УКНЦ и RT-11,
но не используется по умолчанию.
* 2 - Двусторонний дисковод, размер образа 800Кб. Поддерживается родным ПО УКНЦ и RT-11,
и используется по умолчанию в нем.
* 3 - <s>Трехсторонний</s> Диск большой емкости, 256 дорожек, 255 секторов, 2 стороны. Размер
образа ~63Мб. Необходим драйвер для RT-11, есть низкоуровневая поддержка.  

#Программный интерфейс со стороны ПП УКНЦ

&nbsp;&nbsp;&nbsp;&nbsp;
Устройство использует адреса кассеты ПЗУ для взаимодействия с УКНЦ, таким образом,
для включения этих адресов в адресное пространство ПП, необходимо использовать регистр
управления адресным пространством 0177054. При этом отключается часть системного ПЗУ,
поэтому после завершения операции необходимо вернуть прежнее значение регистра.  
&nbsp;&nbsp;&nbsp;&nbsp;
Управление устройством происходит посредством комманд, посылаемых через буфер по адресам
0116000-0117777. Аргументы команды заносятся в буфер, затем происходит инициализация команды
посредством записи ее кода по адресу 117776. После инициализации команды, необходимо ожидать готовности, читая
значение на линии ИНДЕКС, при этом можно вновь подключить системное ПЗУ по адресу 0100000.
Буфер устройства поддерживает только операции со словами. 

| Код команды | Аргументы.<br> Смещение в байтах<br>относительно адреса 116000 | Описание команды         |
|:---------:|---------------------------------------|-------------------------|
|0          | нет				    | __Сброс.__ <br>     Выполняется инициализация обмена с SD-картой<br>и чтение файла map.txt|
|1	    | <b>вход:</b> <br>	2:тип диска 1..3<br>3:N_диска + сторона в старшем бите<br>4:дорожка <br>5:сектор <br><b>выход:</b><br>0:код ошибки или 0<br> 6,7:кол-во переданных БАЙТОВ<br> 8+:данные.  | __Чтение сектора.__<br> Размер сектора фиксирован и равен 512 байт.|
|2	    | <b>вход:</b> <br>	2:тип диска 1..3<br>3:N_диска + сторона в старшем бите<br>4:дорожка <br>5:сектор<br> 8+:данные.  <br><b>выход:</b><br>0:код ошибки или 0<br> 6,7:кол-во переданных БАЙТОВ | __Запись сектора.__|
|3	    | <b>вход:</b> <br>	2:тип диска 1..3<br>3:N_диска + сторона в старшем бите<br>4:дорожка <br>6,7:код в зоне данных <br><b>выход:</b><br>0:код ошибки или 0<br> | __Форматирование дорожки.__<br> Размер сектора фиксирован и равен 512 байт.|
|4	    | <b>вход:</b> <br>	2:кол-во слов для записи в лог<br>8+: данные | __Запись данныхв файл log.txt__<br>Данные записываются в восьмиричном виде. <br> Файл пересоздается при включении питания.<br>Перед каждой записью создается заголовок "log entry:"<br>Используется для отладки.|
|5	    | нет				   | __Задержка в 1мС.__|
|6	    | <b>выход:</b> <br> 0,1: длина map-файла<br>2+: данные| __Чтение файла map.txt__<br>Размер файла не должен превышать 512 байт	|
|7	    | <b>вход:</b> <br> 0,1: длина map-файла<br>2+: данные| __Запись файла map.txt__<br>Размер файла не должен превышать 512 байт	|
|8	    | <b>вход:</b> <br> 0,1: N файла, с которого начинается чтение<br>2,3:кол-во файлов<br><b>выход:</b> <br> 0,1: кол-во байт прочитано<br>2,3: файлов всего<br>4+:имена файлов.|__Чтение каталога disks__<br> Данная команда не проверяет кол-во байт<br>нужно запрашивать не более 64 имен.<br>Имена могут иметь различную длину,<br>разделяются кодом 0|

#Процесс загрузки и программный интерфейс со стороны ЦП УКНЦ.

&nbsp;&nbsp;&nbsp;&nbsp;
Работа устройства начинается, когда пользователь выбирает пункт загрузки с кассеты ПЗУ. Таким образом,
происходит загрузка первых 512 байт прошивки по адресу 0 и осуществляется запуск с этого адреса. Этот
начальный загрузчик загружает оставшуюся часть прошивки начиная с адреса 10000 и производит ее запуск.
После этого выявляется объем доступной для выделения памяти ПП, для этого выделяется весь доступный объем
памяти и сразу освобождается. Далее выделяется 2 куска памяти ПП, один свободный и освобождается, а второй
с необходимым размером в конце области памяти ПП. Это сделано для того, чтобы блок начиная с адреса 23666 был доступен
для любителей писать неперемещаемые программы в памяти ПП. В выделенный блок пересылается код драйвера и запускается.
После этого происходит загрузка первого сектора нулевой дорожки стандартными методами и его запуск с адреса 0, после
чего загружается операционная система обычным способом.  
&nbsp;&nbsp;&nbsp;&nbsp;
В ОЗУ ПП, получив управление драйвер устанавливается как обработчик событий канала 2. После этого, все операции с устроиствами
типа 1,2 и 3 обрабатываются этим драйвером, а операции с другими типами устройств перенаправляются на старый обработчик в ПЗУ.
Таким образом происходит прозрачное для системы подключение дисков и операционная система загружается со стандартными драйверами
в пространстве ЦП.  
&nbsp;&nbsp;&nbsp;&nbsp;
Для просмотра списка файлов-образрв и изменения привязки к виртуальным дискам, (не без помощи форумчан с zx-pk.ru) была разработана 
[программа CHDISK под RT-11](https://github.com/y-salnikov/uknc_sd_fdd/tree/master/PDP-11/rt-11). Параметры запуска:

* -L или --LIST для вывода списка файлов
* -S или --SORT для вывода сортированного списка, работает медленно при большом количестве файлов. 
* N:filename.ext для привязки файла к диску N, где N от 0 до 3. Если файл не существует, то будет создан.

Скриншот с загруженной RT-11 и результат выполнения команды CHDISK -L:
![Скриншот RT-11]({{site.baseurl}}/images/video_capture_017.png)


#Текущее состояние

&nbsp;&nbsp;&nbsp;&nbsp;
Прототип устройства выглядит так: ![Прототип]({{site.baseurl}}/images/controller.jpg)

&nbsp;&nbsp;&nbsp;&nbsp;
В ходе отладки устройства было замечено, что необходимо использовать задержку при выполнении дисковых операций, иначе происходит зависание во время
загрузки ОС. Причину такого поведения установить не удалось.  
&nbsp;&nbsp;&nbsp;&nbsp;
Также вместо линии ИНДЕКС использовался сигнал РЕЖ2, предназначенный для детектирования типа дисковода, но изменеие уровня воспринималось УКНЦ как нажатие
клавиши.  
&nbsp;&nbsp;&nbsp;&nbsp;
Весь код выложен ни github, однако не уверен, что его хватит для сборки, и в PSoC Creator придется производить ручные настройки.
Для компиляции прошивки использовался мой [недо-ассемблер](https://github.com/y-salnikov/not-yet-assembler),
в котором вместо мнемоники используются коды команд.

